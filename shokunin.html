<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>my page</title>
    <meta name="description" content="å†™çœŸæ—¥è¨˜" />
    <meta property="og:title" content="å†™çœŸæ—¥è¨˜" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="#" />
    <meta property="og:site_name" content="å†™çœŸæ—¥è¨˜" />
    <meta property="og:description" content="å†™çœŸæ—¥è¨˜" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="canonical" href="#" />
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/sanitize.css" />
    <link
      href="https://fonts.googleapis.com/earlyaccess/kokoro.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="css/style2.css" />
  </head>

  <body>
    <div class="shokuninArea">
      <div>
        <button type="button" id="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹</button>
      </div>
      <div>
        <h2>ä½œå“æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ </h2>
        <div class="inputArea">
          <div class="toko-1">
            <div class="toko-1-1">
              <p>ä½œè€…ï¼š</p>
              <p id="nameP"></p>
            </div>
            <div class="toko-1-1a">
              <p>ã‚¿ã‚¤ãƒˆãƒ«ï¼š</p>
              <input type="text" id="titleP" />
            </div>
          </div>
          <div class="toko-1">
            <!--ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰-->
            <div class="toko-1-2">
              ä½œå“å†™çœŸ1ã€€<input type="file" id="picture1" />
            </div>
            <div class="toko-1-2">
              ä½œå“å†™çœŸ2ã€€<input type="file" id="picture2" />
            </div>
            <div class="toko-1-2">
              ä½œå“å†™çœŸ3ã€€<input type="file" id="picture3" />
            </div>
          </div>

          <div class="toko-2">
            <!--ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›-->
            <div class="toko-2-1">
              <textarea rows="5" id="work-comment"></textarea>
            </div>
            <!--é€ä¿¡ãƒœã‚¿ãƒ³-->
            <div class="toko-2-1">
              <button type="button" id="send">é€ä¿¡ã™ã‚‹</button>
            </div>
          </div>
        </div>
        <!--é€ä¿¡çµæœã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º-->
        <div class="info-t">
          <p>ä½œå“ä¸€è¦§</p>
          <div class="infoArea">
            <p class="info-p">
              â€»æŠ•ç¨¿ã—ãŸå†…å®¹ã®åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ç”»é¢ãŒå†åº¦è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ä¸‹ã•ã„ã€‚
            </p>
          </div>
        </div>
        <div id="output"></div>
      </div>
      <div id="user-pages">
        <div>
          <h2>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ </h2>
          <div class="inputArea">
            <div class="toko-1">
              <div class="toko-1-1">
                <p>åå‰ï¼š</p>
                <p id="name"></p>
              </div>
              <!--ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰-->
              <div class="toko-1-2"><input type="file" id="picture" /></div>
            </div>
            <div class="toko-2">
              <!--ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›-->
              <div class="toko-2-1">
                <textarea rows="5" id="text"></textarea>
              </div>
              <!--é€ä¿¡ãƒœã‚¿ãƒ³-->
              <div class="toko-2-1">
                <button type="button" id="send">é€ä¿¡ã™ã‚‹</button>
              </div>
            </div>
          </div>
          <!--é€ä¿¡çµæœã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º-->
          <div class="info-t">
            <div class="infoArea">
              <p class="info-p">
                â€»æŠ•ç¨¿ã—ãŸå†…å®¹ã®åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ç”»é¢ãŒå†åº¦è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ä¸‹ã•ã„ã€‚
              </p>
            </div>
          </div>
          <div id="output"></div>
        </div>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
      const start0 = "ãƒ¼";
      const startYear = 2023;
      const endYear = 2050;
      let optionY = "<option>" + start0 + "</option>";
      for (let i = startYear; i <= endYear; i++) {
        optionY += "<option>" + i + "</option>";
      }
      $("#select-years").html(optionY);

      const startMonth = 1;
      const endMonth = 12;
      let optionM = "<option>" + start0 + "</option>";
      for (let i = startMonth; i <= endMonth; i++) {
        optionM += "<option>" + i + "</option>";
      }
      $("#select-months").html(optionM);

      const startDay = 1;
      const endDay = 31;
      let optionD = "<option>" + start0 + "</option>";
      for (let i = startDay; i <= endDay; i++) {
        optionD += "<option>" + i + "</option>";
      }
      $("#select-days").html(optionD);

      // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•° è‡ªåˆ†ã§ä½œã‚‹æ™‚ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰æŒã£ã¦ããŸã»ã†ãŒã„ã„
      function convertTimestampToDatetime(timestamp) {
        const _d = timestamp ? new Date(timestamp * 1000) : new Date();
        const Y = _d.getFullYear();
        const m = (_d.getMonth() + 1).toString().padStart(2, "0");
        const d = _d.getDate().toString().padStart(2, "0");
        const H = _d.getHours().toString().padStart(2, "0");
        const i = _d.getMinutes().toString().padStart(2, "0");
        const s = _d.getSeconds().toString().padStart(2, "0");
        return `${Y}/${m}/${d} ${H}:${i}:${s}`;
      }
    </script>
    <!-- ä»¥ä¸‹ã«firebaseã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚ˆã† -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
      // ğŸ”½ è¿½åŠ  / `9.2.0`ã®éƒ¨åˆ†ã‚’â†‘ã®Firestoreã‹ã‚‰è²¼ã‚Šä»˜ã‘ãŸã‚³ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã‚‹
      import {
        getFirestore,
        collection,
        addDoc, //ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        serverTimestamp,
        query, //æ‰‹å‹•ã§è¿½åŠ 
        orderBy, //æ‰‹å‹•ã§è¿½åŠ  æ¡ä»¶ã®æŒ‡å®š
        onSnapshot, //æ‰‹å‹•ã§è¿½åŠ  ä¸¦ã³æ›¿ãˆ
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        listAll,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
      import {
        getAuth,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      //ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šå‡ºã™
      const loginData = localStorage.getItem("loginJoho");
      if (loginData) {
        const jsonData = JSON.parse(loginData);
        const token = jsonData.token;
        const username = jsonData.username;
        console.log(token, username);
        $("#nameP").html(username.displayName);
      } else {
        console.log("error");
      }

      const firebaseConfig = {
        apiKey: "AIzaSyD35elexPRpTWGpTPLButa3_0-j-0sBMr0",
        authDomain: "social-app-70653.firebaseapp.com",
        projectId: "social-app-70653",
        storageBucket: "social-app-70653.appspot.com",
        messagingSenderId: "424247250561",
        appId: "1:424247250561:web:3c3933d028e2043a16c780",
      };

      //firebaseã‚¬ã‚¤ãƒ‰ã‹ã‚‰å¼•ç”¨
      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);
      const db = getFirestore(app);

      //ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      const auth = getAuth();
      $("#logout").on("click", () => {
        signOut(auth)
          .then(() => {
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸæ™‚ã®å‡¦ç†
            console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
            localStorage.removeItem("loginJoho");
            window.location.href = "index.html";
          })
          .catch((error) => {
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
            console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
          });
      });

      //é€ä¿¡å‡¦ç†
      // $("#send").on("click", function () {
      //   const fileInput = document.getElementById("picture");
      //   let fileName;
      //   if (fileInput.files.length > 0) {
      //     const file = fileInput.files[0];
      //     fileName = file.name;
      //     const spaceRef = ref(storage, fileName);
      //     console.log(spaceRef);
      //     uploadBytes(spaceRef, file).then((snapshot) => {
      //       console.log("Uploaded a file!");
      //       const postData = {
      //         name: $("#name").text(),
      //         text: $("#text").val(),
      //         time: serverTimestamp(),
      //         fileName: fileName,
      //       };
      //       addDoc(collection(db, "post"), postData);
      //       // $("#name").text("");
      //       $("#picture").val("");
      //       $("#text").val("");
      //     });
      //       }
      // }); å…ƒãƒ‡ãƒ¼ã‚¿ï¼ã†ã¾ãã„ã£ãŸã‚„ã¤

      $("#send").on("click", function () {
        const fileInput1 = document.getElementById("picture1");
        let fileName1;
        const fileInput2 = document.getElementById("picture2");
        let fileName2;
        const fileInput3 = document.getElementById("picture3");
        let fileName3;
        if (
          fileInput1.files.length > 0 &&
          fileInput2.files.length > 0 &&
          fileInput3.files.length > 0
        ) {
          const file1 = fileInput1.files[0];
          const file2 = fileInput2.files[0];
          const file3 = fileInput3.files[0];
          fileName1 = file1.name;
          fileName2 = file2.name;
          fileName3 = file3.name;
          const spaceRef1 = ref(storage, fileName1);
          const spaceRef2 = ref(storage, fileName2);
          const spaceRef3 = ref(storage, fileName3);
          console.log(spaceRef1, spaceRef2, spaceRef3);
          uploadBytes(spaceRef1, file1).then((snapshot1) => {
            console.log("Uploaded a file 1!");
            uploadBytes(spaceRef2, file2).then((snapshot2) => {
              console.log("Uploaded a file 2!");
              uploadBytes(spaceRef3, file3).then((snapshot3) => {
                console.log("Uploaded a file 3!");
                const postData = {
                  name: $("#nameP").text(), //name
                  title: $("#titleP").val(), //title
                  workComment: $("#text").val(), //work-comment
                  time: serverTimestamp(), //time
                  fileName1: fileName1, //img1
                  fileName2: fileName2, //img2
                  fileName3: fileName3, //img3
                };
                addDoc(collection(db, "work-post"), postData);
                $("#titleP").val("");
                $("#picture1").val("");
                $("#picture2").val("");
                $("#picture3").val("");
                $("#text").val("");
              });
            });
          });
          //ã“ã®ã‚³ãƒ¼ãƒ‰ã¯å¤±æ•—ã€‚uploadBytesã§ä¸€æ°—ã«3ã¤ã¯èª­ã¿è¾¼ã‚ãªã„ã‚‰ã—ã„ã€‚
          // uploadBytes(
          //   spaceRef1,
          //   file1,
          //   spaceRef2,
          //   file2,
          //   spaceRef3,
          //   file3
          // ).then((snapshot) => {
          //   console.log("Uploaded a file!");
        }
      });

      // ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™æ¡ä»¶
      const q = query(collection(db, "work-post"), orderBy("time", "desc"));
      async function getImageUrlFromStorage(fileName1, fileName2, fileName3) {
        const Image1 = ref(storage, fileName1);
        const url1 = await getDownloadURL(Image1);
        const Image2 = ref(storage, fileName2);
        const url2 = await getDownloadURL(Image2);
        const Image3 = ref(storage, fileName3);
        const url3 = await getDownloadURL(Image3);
        console.log(url1, url2, url3);
        return { url1, url2, url3 };
      }

      onSnapshot(q, async (querySnapshot) => {
        // ã“ã“ã‹ã‚‰ä¸‹ã¯æ¯å›åŒã˜å‡¦ç†
        console.log(querySnapshot.docs);
        const documents = [];
        querySnapshot.docs.forEach(function (doc) {
          const document = {
            id: doc.id,
            data: doc.data(),
          };
          documents.push(document);
          console.log(document.data);
        });

        // ç¢ºèªç”¨
        console.log(documents);

        //ã‚¿ã‚°ã‚’ç”»é¢ã«è¡¨ç¤º è‡ªåˆ†ã§å®šç¾©
        const htmlElements = [];
        for (const document of documents) {
          const timestamp = document.data.time;
          const fileName1 = document.data.fileName1;
          const fileName2 = document.data.fileName2;
          const fileName3 = document.data.fileName3;
          const timeStr = timestamp
            ? convertTimestampToDatetime(timestamp.seconds)
            : "";
          const { url1, url2, url3 } = await getImageUrlFromStorage(
            fileName1,
            fileName2,
            fileName3
          );
          const imageElement1 = `<img src="${url1}" alt="image"/>`;
          const imageElement2 = `<img src="${url2}" alt="image"/>`;
          const imageElement3 = `<img src="${url3}" alt="image"/>`;
          htmlElements.push(`
          <div class="blogBox" id="${document.id}">
                  <div class="titleArea">
                    <p>ä½œè€…ã€€${document.data.name}ã€€ã•ã‚“</p>
                    <p>ã€€${timeStr}</p>
                    </div>
                    <div class="contentArea">
                    <div class="pictureArea">
                    ${imageElement1}
                    </div>
                    <div class="pictureArea">
                    ${imageElement2}
                    </div>
                    <div class="pictureArea">
                    ${imageElement3}
                    </div>
                    <div class="textDataArea">
                    <p id="docDateText">${document.data.title}</p>
                    <p id="docDateText">${document.data.workComment}</p>
                    </div>
                  </div>
          </div>
           `);
        }
        $("#output").html(htmlElements);
      });
    </script>
  </body>
</html>
